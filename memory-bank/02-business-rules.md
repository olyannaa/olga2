# Бизнес-правила и ограничения

## Авторизация и пользователи
- Саморегистрации нет; пользователей создаёт администратор (UI). Через API создание также доступно бухгалтеру и админ‑скоупу, пароль генерируется автоматически.
- Роли хранятся массивом, права объединяются.
- Пользователь может принадлежать нескольким подразделениям; одно `primary` используется как основное.
- Контрагентский пользователь не может иметь подразделений и обязан иметь роль `executor`.

## Проекты и статусы
- Создание проектов доступно admin, scoped admin и gip (только в своих подразделениях).
- При создании проекта менеджер автоматически добавляется в `project_members` с ролью `manager`.
- Статусы проекта: `active`, `completed`, `archived`.
- Удаление возможно только после архивации (soft delete через `deleted_at`).
- При смене менеджера предыдущие `manager` переводятся в `executor`.

## WBS и разделы
- Глубина кода раздела — не более 3 уровней.
- Создание/обновление раздела автоматически создаёт/обновляет связанную задачу (DB‑триггер).
- Удаление раздела удаляет связанную задачу.
- Если по разделу утверждён субподряд, смена исполнителя запрещена.

## Типы задач
- `project` — проектные задачи (в том числе из WBS).
- `personal` — личные задачи пользователя (вне проекта).
- `accounting` — задачи для бухгалтеров (создают admin/gip).
- `project_time` — системные задачи «управление проектом» (создаются автоматически для admin/gip).
- `subcontract` — субподряды по разделам WBS.

## Субподряды
- Создание: только `manager`/`lead_specialist` проекта; обязательны раздел, исполнитель (участник проекта) и стоимость.
- Статусы согласования: `pending`, `approved`, `rejected`.
- Согласование: только админ с `canApproveSubcontracts` и доступом к подразделению проекта.
- После `approved` фиксируется финальная стоимость, исполнитель блокируется, задача становится доступной исполнителю в списках и таймшите.
- `rejected` исключается из выдачи задач.

## Задачи и статусы
- Статусы: `new`, `in_progress`, `review`, `done`.
- Смена статуса доступна через drag‑and‑drop или селект.
- `subcontract` со статусом `pending` нельзя перемещать.
- Перевод в `new` запрещён при наличии time entries (DB‑триггер).
- При первом time entry задача переводится в `in_progress` автоматически.

## Таймшиты
- Запись времени — один клик «+», значение хранится в `hours` (число).
- UI использует шаг 1; половинки (0,5) в интерфейсе не предусмотрены.
- В один день можно отметить несколько задач; в подсчётах день распределяется между задачами (1/N).
- Day‑off коды: `б`, `к`, `о`, `в`; установка очищает записи за день и блокирует новые записи.
- Редактирование доступно только за текущий месяц.
- Для admin/gip существуют системные задачи `project_time` (учёт управления проектом).

## Файлы
- Хранятся только метаданные (имя, URL, описание). Физическое хранилище не интегрировано.
- Бухгалтер не может добавлять/редактировать/удалять файлы проекта.

## Чат
- Текстовые сообщения внутри проекта, без realtime‑канала.

## Аналитика
- Прогресс = доля задач `done` от общего числа задач проекта.
- Трудозатраты = сумма `time_entries.hours`.
